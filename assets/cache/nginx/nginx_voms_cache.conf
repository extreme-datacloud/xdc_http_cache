user build;
worker_processes 1;
events {
    worker_connections 1024;
}

error_log logs/error.log debug;

env X509_VOMS_DIR=/vomsdir;
env X509_CERT_DIR=/etc/pki;

http {
  log_format bodylog '$remote_addr - $remote_user [$time_local] \n'
    '"$request" $status $body_bytes_sent \n'
    '"$ssl_client_i_dn"\n'
    '"$ssl_client_s_dn"\n'
    '"$voms_user"\n'
    '"$voms_user_ca"\n'
    '"$voms_fqans"\n'
    '"$voms_server"\n'
    '"$voms_server_ca"\n'
    '"$voms_vo"\n'
    '"$voms_server_uri"\n'
    '"$voms_not_before"\n'
    '"$voms_not_after"\n'
    '"$voms_generic_attributes"\n'
    '"$voms_serial"\n'
    '"$http_referer" "$http_user_agent" $request_time"\n'
    '<"$request_body" >"$resp_body"\n';

    lua_need_request_body on;

    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;
    proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=one:10m;
    server {

      set $resp_body "";
      body_filter_by_lua '
      local resp_body = string.sub(ngx.arg[1], 1, 1000)
      ngx.ctx.buffered = (ngx.ctx.buffered or "") .. resp_body
      if ngx.arg[2] then
        ngx.var.resp_body = ngx.ctx.buffered
      end
      ';



        access_log logs/access.log bodylog;
        listen 443 ssl;
        server_name cache.example;

        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_certificate /certs/cache_example.cert.pem;
        ssl_certificate_key /certs/cache_example.key.pem;
        ssl_client_certificate /etc/pki/igi-test-ca.pem;
        ssl_verify_client on;
        ssl_verify_depth 100;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        location / {
            # First attempt to serve request as file, then
            # as directory, then fall back to proxy
            try_files $uri $uri/ @proxy;
        }

        location @proxy {

            sendfile  on;

            #dav_methods PUT DELETE MKCOL COPY MOVE;
            #dav_ext_methods PROPFIND OPTIONS;

            proxy_pass https://nginx-voms.example;
            proxy_ssl_verify       on;
            proxy_ssl_verify_depth 5;
            proxy_ssl_certificate /certs/cache_example.cert.pem;
            proxy_ssl_certificate_key /certs/cache_example.key.pem;
            proxy_ssl_trusted_certificate /etc/pki/igi-test-ca.pem;
            proxy_cache one;
            proxy_cache_valid any 1h;
            #echo $voms_user;
            #echo $voms_user_ca;
            #echo $voms_fqans;
            #echo $voms_server;
            #echo $voms_server_ca;
            #echo $voms_vo;
            #echo $voms_server_uri;
            #echo $voms_not_before;
            #echo $voms_not_after;
            #echo $voms_generic_attributes;
            #echo $voms_serial;
            #content_by_lua_block {
            #   ngx.say('Hello, Sammy!')
            #}
        }
    }
}
